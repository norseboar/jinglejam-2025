# ✅ End Phase Implementation Plan

**Goal:** Implement the end phase — surviving enemies damage fortress, restart button appears, and restart functionality resets the game.

**Parent Project:** `docs/project-plan.md` — Task 5

> **For executor:** Follow `.cursor/rules/core-rules.mdc` — follow the plan exactly, stop after each step, don't guess.

---

## Status

- [x] Task 1: Complete _end_battle function
- [x] Task 2: Implement restart function

---

## Summary

**Task 1: Complete _end_battle function** — Handle survivors damaging fortress, update HP display, show restart button.

**Task 2: Implement restart function** — Clear all units, reset game state, re-spawn enemies, restore UI to placement phase.

---

## Tasks

### ✅ Task 1: Complete _end_battle function

**Files:** `scripts/game.gd`

- [x] **Step 1:** Replace the placeholder `_end_battle()` function with the complete implementation:

```gdscript
func _end_battle(player_won: bool) -> void:
	phase = "end"
	
	# Stop all units from moving
	for child in player_units.get_children():
		if child is Unit:
			child.set_state("idle")
	
	for child in enemy_units.get_children():
		if child is Unit:
			child.set_state("idle")
	
	# If player lost, surviving enemies damage the fortress
	if not player_won:
		var surviving_enemies := _count_living_units(enemy_units)
		if surviving_enemies > 0:
			player_hp -= surviving_enemies
			player_hp = max(0, player_hp)  # Don't go below 0
			_update_hp_display()
			print("Fortress took %d damage! %d enemies survived." % [surviving_enemies, surviving_enemies])
	
	# Show restart button
	restart_button.visible = true
	restart_button.disabled = false
	
	print("Battle ended! Player won: ", player_won)
```

**Verify:**

- Ask user to:
  - Run the game scene
  - Spawn units and start battle
  - Let enemies win (or lose intentionally)
  - Confirm surviving enemies reduce fortress HP
  - Confirm HP label updates correctly
  - Confirm "Restart" button appears
  - Check console for damage message

**After this task:** STOP and ask user to verify manually before continuing.

---

### ✅ Task 2: Implement restart function

**Files:** `scripts/game.gd`

- [x] **Step 1:** Replace the placeholder `_on_restart_button_pressed()` function with the complete implementation:

```gdscript
func _on_restart_button_pressed() -> void:
	# Only allow restart during end phase
	if phase != "end":
		return
	
	# Clear all units
	_clear_all_units()
	
	# Wait a frame for units to be fully removed (queue_free needs time)
	await get_tree().process_frame
	
	# Re-spawn enemies
	_spawn_enemies()
	
	# Reset UI to placement phase state
	spawn_button.visible = true
	spawn_button.disabled = false
	start_button.disabled = false
	restart_button.visible = false
	restart_button.disabled = true
	
	# Reset game phase
	phase = "placement"
	
	print("Game restarted!")
```

**Verify:**

- Ask user to:
  - Run the game scene
  - Complete a battle (win or lose)
  - Click "Restart" button
  - Confirm all units are cleared
  - Confirm enemies re-spawn on the right
  - Confirm "Add Unit" button is visible and enabled
  - Confirm "Fight!" button is enabled
  - Confirm "Restart" button is hidden
  - Confirm can spawn new units and play again

**After this task:** STOP and ask user to verify manually before continuing.

---

## Final Code Reference

After all tasks, the relevant parts of `scripts/game.gd` should look like this:

```gdscript
func _end_battle(player_won: bool) -> void:
	phase = "end"
	
	# Stop all units from moving
	for child in player_units.get_children():
		if child is Unit:
			child.set_state("idle")
	
	for child in enemy_units.get_children():
		if child is Unit:
			child.set_state("idle")
	
	# If player lost, surviving enemies damage the fortress
	if not player_won:
		var surviving_enemies := _count_living_units(enemy_units)
		if surviving_enemies > 0:
			player_hp -= surviving_enemies
			player_hp = max(0, player_hp)  # Don't go below 0
			_update_hp_display()
			print("Fortress took %d damage! %d enemies survived." % [surviving_enemies, surviving_enemies])
	
	# Show restart button
	restart_button.visible = true
	restart_button.disabled = false
	
	print("Battle ended! Player won: ", player_won)


func _on_restart_button_pressed() -> void:
	# Only allow restart during end phase
	if phase != "end":
		return
	
	# Clear all units
	_clear_all_units()
	
	# Wait a frame for units to be fully removed (queue_free needs time)
	await get_tree().process_frame
	
	# Re-spawn enemies
	_spawn_enemies()
	
	# Reset UI to placement phase state
	spawn_button.visible = true
	spawn_button.disabled = false
	start_button.disabled = false
	restart_button.visible = false
	restart_button.disabled = true
	
	# Reset game phase
	phase = "placement"
	
	print("Game restarted!")
```

---

## Exit Criteria

- [x] When player loses, surviving enemies reduce fortress HP
- [x] HP label updates when fortress takes damage
- [x] HP cannot go below 0
- [x] "Restart" button appears when battle ends
- [x] Clicking "Restart" clears all units
- [x] Clicking "Restart" re-spawns enemies
- [x] Clicking "Restart" resets UI to placement phase
- [x] Can spawn new units after restart
- [x] Can start a new battle after restart
- [x] Console shows damage and restart messages
- [x] No errors in Godot console

